---
title: "Columns"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE,
  message   = TRUE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%"
  )

gt_style <- function(gt_tbl) {
  gt_tbl |> 
    # opt_all_caps() |>
    fmt_markdown() |> 
    fmt_integer() |> 
    cols_align("left") |> 
    tab_style(
    style = cell_text(align = "center", 
                      size = px(18),
                      weight = "bold"),
    locations = cells_stub()) |> 
    tab_options(
      column_labels.hidden       = TRUE,
      table.font.size            = px(14),
      table.width                = pct(100),
      heading.align = "left",
      heading.title.font.size    = px(16),
      heading.subtitle.font.size = px(16),
      source_notes.font.size     = px(16),
      row_group.as_column        = TRUE,
      row_group.font.size        = px(24)
    )
}

gt_marks <- function(gt_tbl, cols) {

  gt_tbl |>
    gt::text_case_when(
      x == TRUE ~ gt::html(
        fontawesome::fa("check",
                        prefer_type = "solid",
                        fill = "red")),
      x == FALSE ~ gt::html(
        fontawesome::fa("xmark",
                        prefer_type = "solid",
                        fill = "white")),
      .default = NA,
      .locations = gt::cells_body(
        columns = {{ cols }}))
}

modtitle <- "For **Diagnostic Tests**, a blank in this field denotes the **Global Service** & the following Modifiers identify the components:"

f53 <- "Not used to report the elective cancellation of a procedure prior to the patient's anesthesia induction and/or surgical preparation in the operating suite. For outpatient hospital/ambulatory surgery center (ASC) reporting of a previously scheduled procedure/service that is partially reduced or cancelled as a result of extenuating circumstances or those that threaten the well being of the patient prior to or after administration of anesthesia, see modifiers 73 and 74 (see modifiers approved for ASC hospital outpatient use)."

fmod <- "For services other than those with a professional and/or technical component, a blank will appear in this field with one exception: the presence of CPT modifier 53 indicates that separate RVUs and a fee schedule amount have been established for procedures which the physician terminated before completion. This modifier is used only with colonoscopy CPT codes 44388 and 45378, or with G0105 and G0121. Any other codes billed with modifier 53 are subject to carrier medical review and priced by individual consideration."
```

```{r pkgs, message=FALSE, warning=FALSE}
library(northstar)
library(dplyr)
library(gt)
```

# PFS Payment Amount File

This file contains locality-specific physician fee schedule payment amounts for services covered by the Medicare Physician Fee Schedule (MPFS) with one record for each unique combination of carrier, locality, procedure code and modifier.

```{r}
northstar:::col_lb("md", "pfs") |> 
  gt(rowname_col = "var") |>
  gt_style()
```


# PFS Relative Value File

This file contains information on services covered by the Medicare Physician Fee Schedule (MPFS) in 2024. For more than 10,000 physician services, the file contains the associated relative value units (RVUs), a fee schedule status indicator, and various payment policy indicators needed for payment adjustment (i.e., payment of assistant at surgery, team surgery, bilateral surgery, etc.).

The Medicare physician fee schedule amounts are adjusted to reflect the variation in practice costs from area to area. A geographic practice cost index (GPCI) has been established for every Medicare payment locality for each of the three components of a procedureâ€™s relative value unit (i.e., the RVUs for work, practice expense, and malpractice). The GPCIs are applied in the calculation of a fee schedule payment amount by multiplying the RVU for each component times the GPCI for that component.

```{r}
northstar:::col_lb("md", "rvu") |> 
  gt(rowname_col = "var") |>
  gt_style()
```


## Modifier (26/TC/53)

```{r}
dplyr::tibble(mod = c("26", "TC", "53")) |> 
  case_modifier(mod) |>
  gt(rowname_col = "mod") |> 
  tab_header(title = md(modtitle)) |> 
  tab_footnote(f53, locations = cells_stub(rows = 3)) |> 
  tab_footnote(fmod) |> 
  gt_style()
```


## Status

```{r}
x <- sort(c("A", "B", "C", "D", "E", "F", "I", "M", "R", "N", "J", "P", "T", "X"))

dplyr::tibble(status_code = x, 
              code = x) |> 
  case_status(code, desc = TRUE) |> 
  gt(rowname_col = "status_code") |> 
  tab_header(title = md("Indicates whether the code is in the fee schedule and whether it is separately payable if the service is covered. Only RVUs associated with status codes of **A**, **R**, or **T**, are used for Medicare payment.")) |> 
  tab_style(
    style = cell_fill(color = "yellow", alpha = 0.3),
    locations = cells_body(
      columns = everything(),
      rows = c(1, 12, 13))) |> 
  gt_style()
```


## Global

```{r}
dplyr::tibble(global = c("000", "010", "090", "MMM", "XXX", "YYY", "ZZZ")) |> 
  case_global(global) |>
  gt(rowname_col = "global") |> 
  sub_missing(missing_text = "Concept does not apply.") |> 
  gt_style()
```


## PCTC

```{r}
dplyr::tibble(code = as.character(0:9)) |> 
  case_pctc(code) |> 
  gt(rowname_col = "code") |> 
  sub_missing(missing_text = "Concept does not apply.") |> 
  gt_style()
```


## Multiple Procedures

```{r}
dplyr::tibble(code = as.character(c(0:7, 9))) |> 
  case_multproc(code) |>
  gt(rowname_col = "code") |>
  sub_missing(missing_text = "Concept does not apply.") |> 
  gt_style()
```


## Diagnostic Imaging Family

```{r}
img <- stringr::str_pad(c(1:11, 88, 99), width = "2", pad = "0")

dplyr::tibble(dximg = img) |>
  case_imaging(dximg) |> 
  gt(rowname_col = "dximg") |>
  sub_missing(missing_text = "Concept does not apply.") |> 
  gt_style()
```



# Geographic Practice Cost Indices

This file contains the Geographic Practice Cost Index (GPCI) component for each carrier/locality for 2024 as well as the locality/county crosswalk. The GPCI reflects the relative costs of physician work, practice expense, and malpractice insurance in a geographic area compared to the national average costs for each component.

```{r}
note <- "**Note**: The *Further Continuing Appropriations and Other Extensions Act, 2024* (Section 501) extended the 1.0 Work GPCI floor through January 19, 2024. Therefore, the Work GPCIs for 2023 reflect the 1.0 Work GPCI floor. Work GPCIs for 2024 are shown both with and without a 1.0 floor and Work GPCIs for 2025 do not reflect a 1.0 floor."

alaska <- "Work GPCI reflects a 1.5 floor in Alaska established by [**MIPPA**](https://en.wikipedia.org/wiki/Medicare_Improvements_for_Patients_and_Providers_Act_of_2008)."

frontier <- "PE GPCI reflects a 1.0 floor for Frontier States established by the ACA."

macas <- "MAC assignments as of November 22, 2023"

gpci() |> 
  select(-counties) |> 
  gt(rowname_col     = "mac", 
     groupname_col   = "state") |> 
  tab_stubhead(label = "State | MAC") |> 
  cols_label(
    mac      = "MAC",
    state    = "State",
    locality = "Locality",
    name     = "Name",
    wgpci    = "Work",
    pgpci    = "Practice",
    mgpci    = "Malpractice",
    two_macs = "Two MACs") |> 
  cols_merge(columns = c(locality, name),
             pattern = "<b>{1}</b><< {2}>>") |> 
  cols_align(align = "left") |> 
  fmt_number(decimals = 3, 
             drop_trailing_zeros = TRUE) |> 
  tab_footnote(footnote = macas,
               locations = cells_stubhead()) |> 
  tab_footnote(footnote = md(alaska),
               cells_body(columns = locality, rows = 1)) |> 
  tab_footnote(footnote = frontier,
               cells_body(columns = locality, 
                          rows = c(68, 70, 81, 91, 109))) |> 
  tab_footnote(footnote = md(note)) |>
  tab_style(style = cell_text(align = "center", size = px(14)),
            locations = cells_stub()) |> 
  tab_options(
    table.font.size            = px(14),
    table.width                = pct(100),
    heading.title.font.size    = px(16),
    heading.subtitle.font.size = px(16),
    heading.align              = "left",
    source_notes.font.size     = px(16),
    row_group.as_column        = TRUE) |> 
  gt_marks(cols = c(two_macs))
```





