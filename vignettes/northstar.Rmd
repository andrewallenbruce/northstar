---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE,
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%"
  )

library(northstar)
library(fuimus)
library(dplyr)
library(tidyr)
library(purrr)
library(collapse)
library(triebeard)
# library(pathologie)
library(gt)
```


   * Calculate Patient Age  -> Check ICD/HCPCS for Age Conflicts
   * Calculate Provider Lag -> Days between DOS and DOR
   * Calculate Balance      -> Charges - (Payments + Adjustments)
   * Calculate Coinsurance  -> Charges - Allowed



## Load Example

```{r}
(x <- get_example() |> 
   dplyr::filter(!hcpcs %in% c("WCPAIN", 
                               "MATERIALCTR", 
                               "MATERIALOFF", 
                               "MEDREC",
                               "SPBARIATRIC", 
                               "LETTER")) |> 
   dplyr::mutate(
     # coinsurance = charges - allowed,
     balance = charges - (payments + adjustments), 
     .after = adjustments))
```

## Place of Service

```{r}
pos_trie <- triebeard::trie(
    keys = search_pos()$pos_code,
    values = chr(search_pos()$pos_type))

pos_trie
```


```{r}
x_pos <- x |> 
  dplyr::mutate(
    pos_type = triebeard::longest_match(pos_trie, pos), 
    .after = pos)

x_pos
```


## Categorize HCPCS

```{r}
# hcpcs_unq <- collapse::funique(x$hcpcs[!x$hcpcs %in% not_hcpcs])
hcpcs_unq <- collapse::funique(x$hcpcs)

search_rbcs(hcpcs_code = hcpcs_unq) |> 
  dplyr::select(hcpcs_code:rbcs_family) |> 
  dplyr::left_join(
    search_descriptions(hcpcs_code = hcpcs_unq, 
                        hcpcs_desc_type = "Long") |> 
  dplyr::select(hcpcs_code, hcpcs_description),
  by = dplyr::join_by(hcpcs_code))
```

## Define Modifiers

```{r}
mod_unq <- strsplit(toupper(x$mod[!is.na(x$mod)]), "-") |> 
  list_c() |> 
  funique()

search_modifiers(mod_code = mod_unq) |> 
  select(mod_code, mod_description)
```



```{r}
x |> 
  select(claim_id, dos, order, hcpcs) |> 
  group_by(claim_id) |> 
  filter(n() > 1) |> 
  ungroup()
```

```{r}
aocs <- search_aocs(hcpcs_code = hcpcs_unq) |> 
  tidyr::unnest(cols = aoc_complements)

aoc_pairs <- aocs |> 
  filter(aoc_type == "Primary") |> 
  select(hcpcs_primary = hcpcs_code, hcpcs_addon = aoc_complement)

ex_aoc <- x |> 
  select(claim_id, dos, order, hcpcs) |> 
  group_by(claim_id) |> 
  filter(n() > 1) |> 
  ungroup()

prim <- ex_aoc |> 
  filter(order == 1) |> 
  select(claim_id, dos, hcpcs_primary = hcpcs)

addon <- ex_aoc |> 
  filter(order != 1) |> 
  select(claim_id, dos, order_addon = order, hcpcs_addon = hcpcs)

addon |> 
  left_join(prim, by = join_by(claim_id, dos)) |> 
  filter(claim_id %in% c('46440-13', '16057-35', '57128-01')) #|>
  # semi_join(aoc_pairs) |> 
  # pull(claim_id)
```



